## pnpm

> [官网指路：https://www.pnpm.cn/installation](https://www.pnpm.cn/installation)

### Monorepo模式是什么：
Monorepo 是一种项目开发与管理的策略模式，它代表"单一代码仓库"（Monolithic Repository）。在 Monorepo 模式中，所有相关的项目和组件都被存储在一个统一的代码仓库中，而不是分散在多个独立的代码仓库中，这些项目之间还可能会有依赖关系。npm、yarn、pnpm 等包管理工具与 monorepo 的关系在于它们可以为 monorepo 提供依赖安装与依赖管理的支持，借助自身对 workspace 的支持，允许在 monorepo 中的不同子项目之间共享依赖项，并提供一种管理这些共享依赖项的方式，这可以简化依赖项管理和构建过程，并提高开发效率。

### 曾经主流单仓库模式为什么有点过时

* 代码和配置很难共享：每个仓库都需要做一些重复的工程化能力配置（如 eslint/test/ci 等）且无法统一维护，且不利于代码复用。
* 依赖的治理复杂：模块越来越多，涉及多模块同时改动的场景增加。如何保障底层组件升级后，其引用到的组件也能同步更新到位。这点很难做到，如果没及时升级，各工程的依赖版本不一致，往往会引发一些意想不到的问题。
* 开发人员缺乏对整个项目的整体认知：开发人员一般只关心自己的服务代码，看不到项目整体，造成缺乏对项目整体架构和业务目标整体性的理解。
* 存储和构建消耗增加：假如多个工程依赖 pkg-a，那么每个工程下 node_modules 都会重复安装 pkg-a，对本地磁盘内存和本地启动都是个很大的挑战。而且每个模块的发布都是相对独立的，当一次迭代修改较多模块时，总体发布时效就是每个发布流程的串联。对发布者来说是一个非常大的负担。

### Monorepo（单仓多模块）开发模式

* 允许在一个代码库中管理多个项目、组件或服务，提供更好的代码共享和重用性
* 管理所有项目的版本控制更加容易和一致，降低了不同项目之间的版本冲突
* 可以统一项目的构建和部署流程，降低了配置和维护多个项目所需的工作量。
* 这种模式需要注意权限问题和仓库代码维护，建议单人维护合并代码，其余人只负责提交。否则容易一坨

### 模拟Monorepo场景

比如vant，vant一个组件库，有vant-ui、vant-use、vant-cli等项目，如果分成多个仓库，则每次发布更新都需要统一对其他仓库进行部署更新（vant-ui需要引入vant-use中的方法，vant-cli引入vant-ui组件等依赖关系），且需要统一不同项目直接的线上版本。

### 为什么用（为什么npm和yarn不够用了）

* 扁平化依赖算法复杂，需要消耗较多的性能，依赖串行安装还有提速空间。
* 大量文件需要重复下载，对磁盘空间的利用率不足。（虽然在同一个项目中我不会重复的安装依赖 d 了，但是如果我有100个项目，100个项目都需要用到某个包，那么这个包依然会被下载100次，也就是在磁盘的不同地方写入100次）
* 扁平化依赖虽然解决了不少问题，但是随即带来了依赖非法访问的问题，项目代码在某些情况下可以在代码中使用没有被定义在 package.json 中的包，这种情况就是我们常说的幽灵依赖。

### 什么情况下用

1. 不同的项目模块开发、构建、测试存在依赖、引用、交叉引用
2. 不同的项目模块共享同一配置
3. 不同的项目模块直接存在强版本关联耦合

### 浅谈pnpm速度快原因（不谈原理，我也不懂）

1. 安装依赖提速：解析依赖树，决定要下载哪些安装包，然后便多个依赖一起下载，来增加速度，最后解压包构建真正的依赖树
2. 使用硬连接的方式节约磁盘空间利用率、采用虚拟存储目录+`软连接(包含一条以绝对路径或相对路径的形式指向其他文件或者目录的引用，类似与‘快捷方式’)`解决幽灵依赖，平铺的结构避免了 npm v2 创建的嵌套 node_modules 引起的长路径问题，但与 npm v3,4,5,6 或 yarn v1 创建的平铺的 node_modules 不同的是，它保留了包之间的相互隔离。
3. 技术生态支持